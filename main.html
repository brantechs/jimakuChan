<!DOCTYPE html>
<html>
 
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css?family=M+PLUS+1p" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css?family=Hachi+Maru+Pop" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Yusei+Magic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Reggae+One" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Sawarabi+Gothic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">

    <link href="./font.css" rel="stylesheet">

    <link rel="icon" href="./img/favicon2/favicon.ico" />
    <script src="js/bouyomichan_client.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FKQVD3TMXH"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FKQVD3TMXH');
    </script>
    <!-- END: Google tag (gtag.js) -->


    <title>jimakuChan：音声認識字幕ちゃん</title>

    <style type="text/css">
        button, input, select, textarea {
            /* font-family : inherit; */
            /* font-family: 'メイリオ', Meiryo,sans-serif; */
            /* font-size   : 300%; */
            /* color  : black; */
            font-weight : 0;
            /*text-align  : center;       /* left, center, right */
            vertical-align : top;    /* top, middle, bottom */
            -webkit-text-stroke-color: rgb(21, 0, 141);
            -webkit-text-stroke-width: 0px;
        }

        html {
            height: 100%;
            width: 100%;
        }

        body {
            height: 100%;
            width: 100%;
            margin: 0;
            overflow:hidden;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            /* font-family:'07NikumaruFont'; */
        }
        table {
            width: 100%;
            overflow:hidden;
            /* table-layout: fixed; */
        }
        table.btm_table {
            position:absolute;
            /* bottom:0; */
        }

        table td {
            /*word-break: break-all;*/
            overflow-wrap : break-word;
        }
    </style>

    <style>
        /* prepare the selectors to add a stroke to */

        .stroke-single-imb{
            /* position: absolute; */
            left: 0;
            right: 0;
            margin: 0;
            margin-left: 5px;
            /* -webkit-text-stroke: 0px #0000FF;  */
        }

        .stroke-single-bg{
            position: absolute;
            left: 0;
            right: 0;
            margin: auto;
            margin-left: 5px;
            /* -webkit-text-stroke: 3px #FF0000;  */
        }
        /* add a single stroke */
        .stroke-single-fg{
            position: absolute;
            left: 0;
            right: 0;
            margin: auto;
            margin-left: 5px;
            /* -webkit-text-stroke: 0px #FFFFFF; */
        }

    </style>

    <script>

        // URLパラメータ取得用関数 ---------------------------
        function getParam(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&]*)|&|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // 一定時間変化がなかったら消す ------------------------------------
        var fn_del = function() {
            document.getElementById('speech_text-imb').innerHTML = '';
            document.getElementById('speech_text-bg').innerHTML = '';
            document.getElementById('speech_text-fg').innerHTML = '';
            document.getElementById('trans_text-imb').innerHTML = '';
            document.getElementById('trans_text-bg').innerHTML = '';
            document.getElementById('trans_text-fg').innerHTML = '';
            document.getElementById('trans_text2-imb').innerHTML = '';
            document.getElementById('trans_text2-bg').innerHTML = '';
            document.getElementById('trans_text2-fg').innerHTML = '';
            document.getElementById('trans_text3-imb').innerHTML = '';
            document.getElementById('trans_text3-bg').innerHTML = '';
            document.getElementById('trans_text3-fg').innerHTML = '';

            // 各フラグをリセット
            isSpeechRecognitionComplete = false;
            isTextTranslation1Complete = false;
            isTextTranslation2Complete = false;
            isTextTranslation3Complete = false;
            
            // 保持テキストもクリア
            currentInterimText = '';
            lastFinalText = '';
        };


        // URLからの値読み込み(削除タイマー) -------------------
        var timer = getParam('timer');
        
        // 一定時間認識結果がなかったら，そこで認識終了 --------------------
        var short_pause = getParam('short_pause');
        
        // デバッグ用：タイマー設定を確認
        console.log('タイマー設定:', {
            timer: timer + 'ms (テキスト削除)',
            short_pause: short_pause + 'ms (音声ポーズ検出)'
        });

        //////////////////////////////////////////////////////////
        // URLからの値読み込み -------------------
        var arg_showAudioLevel = getParam('showAudioLevel');
        var arg_enhanceAccuracy = getParam('enhanceAccuracy');
        var arg_noiseReduction = getParam('noiseReduction');
        var arg_volumeNormalization = getParam('volumeNormalization');
        var arg_showConfidence = getParam('showConfidence');
        var arg_useCustomDictionary = getParam('useCustomDictionary');
        var arg_customDictionary = getParam('customDictionary');
        var arg_recog = getParam('recog');
        console.log('音声認識言語パラメータ:', arg_recog);
        var arg_trans = getParam('trans');
        var arg_trans2 = getParam('trans2');
        var arg_trans3 = getParam('trans3');

        /////////////////////////////////////////////////////////
        // 翻訳API用設定 ---------------------------
        if (arg_trans != null) var request = new XMLHttpRequest();
        if (arg_trans2 != null) var request2 = new XMLHttpRequest();
        if (arg_trans3 != null) var request3 = new XMLHttpRequest();

        // 翻訳用設定 ---------------------------
        var trans_sourcelang = 'ja';
        var trans_destlang = 'en';
        var trans2_destlang = '';
        var trans3_destlang = '';


        var gasKeys = [];
        var firstKey = getParam('gas_key');
        if (firstKey != null && firstKey !== '') gasKeys.push(firstKey);
        for (var i = 2; i <= 5; i++) {
            var k = getParam('gas_key' + i);
            if (k != null && k !== '') gasKeys.push(k);
        }
        var currentGasKeyIndex = 0;
        var TOKEN_THRESHOLD = 4800;
        var TRANS_URL = '';
        function updateTransUrl() {
            if (gasKeys.length > 0) {
                TRANS_URL = 'https://script.google.com/macros/s/' + gasKeys[currentGasKeyIndex] + '/exec';
            } else {
                TRANS_URL = '';
            }
        }
        function rotateGasKey() {
            if (gasKeys.length > 1) {
                currentGasKeyIndex = (currentGasKeyIndex + 1) % gasKeys.length;
                updateTransUrl();
                console.log('rotateGasKey -> index:' + currentGasKeyIndex);
            }
        }
        updateTransUrl();
        var tokenUsage = {};
        var query = ''

        // その他の設定 -----------------------
        var bouyomi = getParam('bouyomi');
        var anti_sexual = getParam('anti_sexual');
        
        // カスタム辞書の準備
        var customDictionary = {};
        if (arg_useCustomDictionary === 'true' && arg_customDictionary) {
            try {
                const dictionaryText = decodeURIComponent(arg_customDictionary);
                const entries = dictionaryText.split('、').concat(dictionaryText.split(','));
                entries.forEach(entry => {
                    const parts = entry.split('=');
                    if (parts.length === 2) {
                        customDictionary[parts[0].trim()] = parts[1].trim();
                    }
                });
                console.log('カスタム辞書を読み込みました:', Object.keys(customDictionary).length + '件');
            } catch (error) {
                console.error('カスタム辞書の解析に失敗:', error);
            }
        }
        
        // 翻訳前処理関数（カスタム辞書適用）
        function applyCustomDictionary(text) {
            if (arg_useCustomDictionary !== 'true' || Object.keys(customDictionary).length === 0) {
                return text;
            }
            
            let processedText = text;
            for (const [key, value] of Object.entries(customDictionary)) {
                const regex = new RegExp('\\b' + key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                processedText = processedText.replace(regex, value);
            }
            return processedText;
        }

        // 不適切語フィルタリング関数（音声認識用）
        function applyContentFilter(text) {
            if (anti_sexual === 'false' || badWords_forRecog.length === 0) {
                return text;
            }
            
            let filteredText = text;
            
            // 保護する単語を一時的なプレースホルダーに置き換える
            goodWords_forRecog.forEach((word, index) => {
                if (word && word.trim() !== '') {
                    let placeholder = `{{GOOD_WORD_${index}}}`;
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    filteredText = filteredText.replace(regex, placeholder);
                }
            });

            // 不適切語を***に置き換える
            badWords_forRecog.forEach(word => {
                if (word && word.trim() !== '') {
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    filteredText = filteredText.replace(regex, "*".repeat(word.length));
                }
            });

            // 一時的なプレースホルダーを保護する単語に戻す
            goodWords_forRecog.forEach((word, index) => {
                if (word && word.trim() !== '') {
                    let placeholder = `{{GOOD_WORD_${index}}}`;
                    const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "g");
                    filteredText = filteredText.replace(regex, word);
                }
            });

            return filteredText;
        }

        // 翻訳結果用フィルタリング関数
        function applyTranslationFilter(text, transType) {
            if (anti_sexual === 'false' || !text || text.trim() === '') {
                return text;
            }
            
            let badWordsList, goodWordsList;
            
            // 翻訳タイプに応じて適切な不適切語リストを選択
            switch(transType) {
                case 1:
                    badWordsList = badWords_forTrans1;
                    goodWordsList = goodWords_forTrans1;
                    break;
                case 2:
                    badWordsList = badWords_forTrans2;
                    goodWordsList = goodWords_forTrans2;
                    break;
                case 3:
                    badWordsList = badWords_forTrans3;
                    goodWordsList = goodWords_forTrans3;
                    break;
                default:
                    return text;
            }
            
            if (badWordsList.length === 0) {
                console.log('翻訳' + transType + '用の不適切語リストが空のため、フィルタリングをスキップ');
                return text;
            }
            
            let filteredText = text;
            
            // 保護する単語を一時的なプレースホルダーに置き換える
            goodWordsList.forEach((word, index) => {
                if (word && word.trim() !== '') {
                    let placeholder = `{{TRANS${transType}_GOOD_WORD_${index}}}`;
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    filteredText = filteredText.replace(regex, placeholder);
                }
            });

            // 不適切語を***に置き換える
            badWordsList.forEach(word => {
                if (word && word.trim() !== '') {
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    filteredText = filteredText.replace(regex, "*".repeat(word.length));
                }
            });

            // 一時的なプレースホルダーを保護する単語に戻す
            goodWordsList.forEach((word, index) => {
                if (word && word.trim() !== '') {
                    let placeholder = `{{TRANS${transType}_GOOD_WORD_${index}}}`;
                    const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "g");
                    filteredText = filteredText.replace(regex, word);
                }
            });

            console.log('翻訳' + transType + 'フィルタリング: "' + text + '" -> "' + filteredText + '"');
            return filteredText;
        }


        // 一定時間認識結果がなかったら，そこで認識終了 --------------------
        // short_pauseは上部で既に定義済み

        var stop_recog;
        var id_stop_recog;

        var count = 0;

        // URLから Bad/Good 単語リストをリスト形式で読み込む -----------------------
        // ハイフン付き言語コードをファイルパス用にマッピング
        function getFilterLanguageId(langCode) {
            const languageMapping = {
                'zh-CN': 'zh',     // 中国語（簡体字）
                'zh-TW': 'zh',     // 台湾語（繁体字） → 中国語フィルターを使用
                'zh-HK': 'zh',     // 香港語（繁体字） → 中国語フィルターを使用
                'en-US': 'en',     // アメリカ英語 → 英語フィルターを使用
                'fr-FR': 'fr',     // フランス語
                'it-IT': 'it',     // イタリア語
                'de-DE': 'de',     // ドイツ語
                'tr-TR': 'tr',     // トルコ語
                'sv-SE': 'sv',     // スウェーデン語
                'pl-PL': 'pl',     // ポーランド語
                'uk-UA': 'uk',     // ウクライナ語
                'ru-RU': 'ru',     // ロシア語
                'es-ES': 'es',     // スペイン語
                'pt-PT': 'pt'      // ポルトガル語
            };
            
            return languageMapping[langCode] || langCode;
        }
        
        let languageId = getFilterLanguageId(arg_recog);
        const baseURL = "https://raw.githubusercontent.com/sayonari/goodBadWordlist/main/";
        const badListPath = `/BadList.txt`; // 禁止ワードリストのパス
        const goodListPath = `/GoodList.txt`; // 許可ワードリストのパス
        var badWords_forRecog = [];
        var goodWords_forRecog = [];
        
        // 翻訳結果用の不適切語リスト
        var badWords_forTrans1 = [];
        var goodWords_forTrans1 = [];
        var badWords_forTrans2 = [];
        var goodWords_forTrans2 = [];
        var badWords_forTrans3 = [];
        var goodWords_forTrans3 = [];

        console.log("original lang code: " + arg_recog + " -> filter lang: " + languageId);
        console.log("url: " + baseURL + languageId + badListPath);
        if (anti_sexual !== 'false') {
            // 禁止ワードリストを読み込む
            fetch(baseURL + languageId + badListPath)
                .then( r => r.text() )
                .then( t => {
                    badWords_forRecog = t.split("\n").filter(Boolean);
                    console.log("loaded Bad Words num: " + badWords_forRecog.length);
                });

            // 許可ワードリストを読み込む
            fetch(baseURL + languageId + goodListPath)
                .then( r => r.text() )
                .then( t => {
                    goodWords_forRecog = t.split("\n").filter(Boolean);
                });
                
            // 翻訳言語1の不適切語リストを読み込む
            if(arg_trans != null) {
                const trans1LangId = getFilterLanguageId(arg_trans);
                console.log("trans1 lang: " + arg_trans + " -> filter lang: " + trans1LangId);
                fetch(baseURL + trans1LangId + badListPath)
                    .then( r => r.text() )
                    .then( t => {
                        badWords_forTrans1 = t.split("\n").filter(Boolean);
                        console.log("loaded Trans1 Bad Words num: " + badWords_forTrans1.length);
                    })
                    .catch(e => console.log("Trans1 Bad Words list not found for: " + trans1LangId));
                    
                fetch(baseURL + trans1LangId + goodListPath)
                    .then( r => r.text() )
                    .then( t => {
                        goodWords_forTrans1 = t.split("\n").filter(Boolean);
                    })
                    .catch(e => console.log("Trans1 Good Words list not found for: " + trans1LangId));
            }
            
            // 翻訳言語2の不適切語リストを読み込む
            if(arg_trans2 != null) {
                const trans2LangId = getFilterLanguageId(arg_trans2);
                console.log("trans2 lang: " + arg_trans2 + " -> filter lang: " + trans2LangId);
                fetch(baseURL + trans2LangId + badListPath)
                    .then( r => r.text() )
                    .then( t => {
                        badWords_forTrans2 = t.split("\n").filter(Boolean);
                        console.log("loaded Trans2 Bad Words num: " + badWords_forTrans2.length);
                    })
                    .catch(e => console.log("Trans2 Bad Words list not found for: " + trans2LangId));
                    
                fetch(baseURL + trans2LangId + goodListPath)
                    .then( r => r.text() )
                    .then( t => {
                        goodWords_forTrans2 = t.split("\n").filter(Boolean);
                    })
                    .catch(e => console.log("Trans2 Good Words list not found for: " + trans2LangId));
            }
            
            // 翻訳言語3の不適切語リストを読み込む
            if(arg_trans3 != null) {
                const trans3LangId = getFilterLanguageId(arg_trans3);
                console.log("trans3 lang: " + arg_trans3 + " -> filter lang: " + trans3LangId);
                fetch(baseURL + trans3LangId + badListPath)
                    .then( r => r.text() )
                    .then( t => {
                        badWords_forTrans3 = t.split("\n").filter(Boolean);
                        console.log("loaded Trans3 Bad Words num: " + badWords_forTrans3.length);
                    })
                    .catch(e => console.log("Trans3 Bad Words list not found for: " + trans3LangId));
                    
                fetch(baseURL + trans3LangId + goodListPath)
                    .then( r => r.text() )
                    .then( t => {
                        goodWords_forTrans3 = t.split("\n").filter(Boolean);
                    })
                    .catch(e => console.log("Trans3 Good Words list not found for: " + trans3LangId));
            }
        }


        // 音声認識本体 /////////////////////////////////////////////////
        window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;

        // Web Speech APIはデバイス選択をサポートしないため、この処理は無効
        function initializeAudioDevice() {
            console.log('Web Speech APIは既定の音声デバイスのみ使用します');
            return Promise.resolve();
        }

        // 音声認識用設定 ----------------------
        var recognition = new webkitSpeechRecognition();
        recognition.lang = 'ja';
        recognition.interimResults = true;
        // recognition.continuous = true;
        var recog_text = '';
        var recog_IM_text = '';
        var recog_conf = 0;
        var trans_text = '';
        var trans2_text = '';
        var trans3_text = '';

        var my_count = count;
        count = count + 1;

        // その他設定 ----------------------------
        var isSpeechRecognitionComplete = false;
        var isTextTranslation1Complete = false;
        var isTextTranslation2Complete = false;
        var isTextTranslation3Complete = false;
        var currentInterimText = '';  // 現在の途中結果を保持
        var lastFinalText = '';       // 最後の確定結果を保持

        // 分離されたタイマー管理システム ----------------------------
        var speechDeleteTimerId = null;  // 音声認識テキスト削除タイマーのID
        var translationDeleteTimerId = null;  // 翻訳テキスト削除タイマーのID
        
        // 独立したプログレスバー管理
        var speechProgressUpdateIntervalId = null;  // 音声認識プログレスバー更新用インターバルID
        var speechTimerStartTime = null;  // 音声認識タイマー開始時刻
        var speechTimerDuration = null;   // 音声認識タイマー継続時間
        
        var translationProgressUpdateIntervalId = null;  // 翻訳プログレスバー更新用インターバルID
        var translationTimerStartTime = null;  // 翻訳タイマー開始時刻
        var translationTimerDuration = null;   // 翻訳タイマー継続時間

        // 音声認識テキストを全角スペースで置き換える関数
        function clearSpeechText() {
            document.getElementById('speech_text-imb').innerHTML = '　'; // 全角スペース
            document.getElementById('speech_text-bg').innerHTML = '　';
            document.getElementById('speech_text-fg').innerHTML = '　';
            console.log('音声認識テキストをクリア（全角スペース置換）');
        }

        // 翻訳テキストを全角スペースで置き換える関数
        function clearTranslationText() {
            if(arg_trans != null) {
                document.getElementById('trans_text-imb').innerHTML = '　';
                document.getElementById('trans_text-bg').innerHTML = '　';
                document.getElementById('trans_text-fg').innerHTML = '　';
            }
            if(arg_trans2 != null) {
                document.getElementById('trans_text2-imb').innerHTML = '　';
                document.getElementById('trans_text2-bg').innerHTML = '　';
                document.getElementById('trans_text2-fg').innerHTML = '　';
            }
            if(arg_trans3 != null) {
                document.getElementById('trans_text3-imb').innerHTML = '　';
                document.getElementById('trans_text3-bg').innerHTML = '　';
                document.getElementById('trans_text3-fg').innerHTML = '　';
            }
            console.log('翻訳テキストをクリア（全角スペース置換）');
        }

        // 音声認識テキスト削除タイマーをリセットする関数
        function resetSpeechTimer() {
            if (speechDeleteTimerId !== null) {
                console.log('🔄 音声認識テキスト削除タイマーをリセット (ID:' + speechDeleteTimerId + ')');
                clearTimeout(speechDeleteTimerId);
                speechDeleteTimerId = null;
            } else {
                console.log('⚪ 音声認識タイマーリセット要求（タイマーなし）');
            }
            // 音声認識プログレスバーのみリセット
            if (speechProgressUpdateIntervalId !== null) {
                clearInterval(speechProgressUpdateIntervalId);
                speechProgressUpdateIntervalId = null;
            }
            updateTimerProgressBar(0, '🎤待機', 'linear-gradient(90deg, #FF6B6B 0%, #FFA07A 50%, #FFE4E1 100%)', 'speech');
        }

        // 翻訳テキスト削除タイマーをリセットする関数
        function resetTranslationTimer() {
            if (translationDeleteTimerId !== null) {
                console.log('🔄 翻訳テキスト削除タイマーをリセット (ID:' + translationDeleteTimerId + ')');
                clearTimeout(translationDeleteTimerId);
                translationDeleteTimerId = null;
            }
            // 翻訳プログレスバーのみリセット
            if (translationProgressUpdateIntervalId !== null) {
                clearInterval(translationProgressUpdateIntervalId);
                translationProgressUpdateIntervalId = null;
            }
            updateTimerProgressBar(0, '🌐待機', 'linear-gradient(90deg, #2196F3 0%, #64B5F6 50%, #BBDEFB 100%)', 'translation');
        }

        // 音声認識テキスト削除タイマーを開始する関数
        function startSpeechDeleteTimer() {
            resetSpeechTimer(); // 既存のタイマーをクリア
            
            if (timer != null && timer !== '') {
                var duration = parseInt(timer);
                
                if (isNaN(duration) || duration <= 0) {
                    console.log('❌ 音声認識タイマー開始失敗: 無効な時間設定:', timer);
                    return;
                }
                
                speechDeleteTimerId = setTimeout(function() {
                    console.log('⏰ 音声認識タイマー満了 - テキストをクリア (ID:' + speechDeleteTimerId + ')');
                    clearSpeechText();
                    speechDeleteTimerId = null;
                    updateTimerProgressBar(0, '🎤完了', '#4CAF50', 'speech');
                    setTimeout(function() {
                        updateTimerProgressBar(0, '🎤待機', 'linear-gradient(90deg, #FF6B6B 0%, #FFA07A 50%, #FFE4E1 100%)', 'speech');
                    }, 1000);
                }, duration);
                
                console.log('🎤⏱️ 音声認識テキスト削除タイマー開始:', duration + 'ms', '(ID:' + speechDeleteTimerId + ')');
                
                // プログレスバーのカウントダウン開始
                startProgressBarCountdown(duration, 'speech');
            } else {
                console.log('❌ 音声認識タイマー開始失敗: timer設定なし (timer=' + timer + ')');
            }
        }

        // 翻訳テキスト削除タイマーを開始する関数
        function startTranslationDeleteTimer() {
            resetTranslationTimer(); // 既存のタイマーをクリア
            
            if (timer != null && timer !== '') {
                var duration = parseInt(timer);
                
                translationDeleteTimerId = setTimeout(function() {
                    console.log('翻訳タイマー満了 - テキストをクリア');
                    clearTranslationText();
                    translationDeleteTimerId = null;
                }, duration);
                
                console.log('🌐⏱️ 翻訳テキスト削除タイマー開始:', timer + 'ms');
                
                // 翻訳タイマーの場合はプログレスバーを青色で表示
                startProgressBarCountdown(duration, 'translation');
            }
        }

        // 翻訳ステータス更新関数
        function updateTranslationStatus(status, color) {
            try {
                if (window.parent && window.parent.document) {
                    var statusElement = window.parent.document.getElementById('translationStatus');
                    if (statusElement) {
                        statusElement.innerHTML = status;
                        statusElement.style.color = color || '#666';
                    }
                }
            } catch (error) {
                console.log('翻訳ステータス更新エラー:', error);
            }
        }

        // タイマープログレスバー更新関数（個別バー対応）
        function updateTimerProgressBar(percent, text, color, type) {
            try {
                if (window.parent && window.parent.document) {
                    var barId = type === 'translation' ? 'transTimerProgressBar' : 'speechTimerProgressBar';
                    var textId = type === 'translation' ? 'transTimerProgressText' : 'speechTimerProgressText';
                    
                    var progressBar = window.parent.document.getElementById(barId);
                    var progressText = window.parent.document.getElementById(textId);
                    
                    if (progressBar && progressText) {
                        progressBar.style.width = percent + '%';
                        progressText.innerHTML = text;
                        
                        if (color) {
                            progressBar.style.background = color;
                        }
                    }
                }
            } catch (error) {
                console.log('プログレスバー更新エラー:', error);
            }
        }

        // プログレスバーのカウントダウンアニメーションを開始（独立版）
        function startProgressBarCountdown(duration, type) {
            var intervalId;
            var startTime;
            var timerDuration;
            
            if (type === 'translation') {
                // 翻訳用プログレスバーの既存更新を停止
                if (translationProgressUpdateIntervalId !== null) {
                    clearInterval(translationProgressUpdateIntervalId);
                    translationProgressUpdateIntervalId = null;
                }
                translationTimerStartTime = Date.now();
                translationTimerDuration = duration;
                startTime = translationTimerStartTime;
                timerDuration = translationTimerDuration;
            } else {
                // 音声認識用プログレスバーの既存更新を停止
                if (speechProgressUpdateIntervalId !== null) {
                    clearInterval(speechProgressUpdateIntervalId);
                    speechProgressUpdateIntervalId = null;
                }
                speechTimerStartTime = Date.now();
                speechTimerDuration = duration;
                startTime = speechTimerStartTime;
                timerDuration = speechTimerDuration;
            }

            // タイマー種類に応じて色を決定
            var colorGradient;
            var typeText = '';
            if (type === 'translation') {
                colorGradient = 'linear-gradient(90deg, #2196F3 0%, #64B5F6 50%, #BBDEFB 100%)';
                typeText = '🌐';
            } else {
                colorGradient = 'linear-gradient(90deg, #FF6B6B 0%, #FFA07A 50%, #FFE4E1 100%)';
                typeText = '🎤';
            }

            // プログレスバー初期化
            var initialSeconds = Math.round(duration / 1000);
            updateTimerProgressBar(100, typeText + ' ' + initialSeconds + 's', colorGradient, type);

            // 50ms毎にプログレスバーを更新（より滑らか）
            intervalId = setInterval(function() {
                var elapsed = Date.now() - startTime;
                var remaining = Math.max(0, timerDuration - elapsed);
                var percent = (remaining / timerDuration) * 100;
                var remainingSeconds = Math.ceil(remaining / 1000);

                if (remaining > 0) {
                    // 残り時間に応じて色を変化
                    var urgencyLevel = remaining / timerDuration;
                    var displayColor;
                    if (urgencyLevel > 0.5) {
                        displayColor = colorGradient;
                    } else if (urgencyLevel > 0.2) {
                        displayColor = 'linear-gradient(90deg, #FFA726 0%, #FFB74D 50%, #FFE0B2 100%)';
                    } else {
                        displayColor = 'linear-gradient(90deg, #F44336 0%, #EF5350 50%, #FFCDD2 100%)';
                    }
                    
                    updateTimerProgressBar(percent, typeText + ' ' + remainingSeconds + 's', displayColor, type);
                } else {
                    updateTimerProgressBar(0, typeText + ' 削除!', '#D32F2F', type);
                    clearInterval(intervalId);
                    
                    // インターバルIDをクリア
                    if (type === 'translation') {
                        translationProgressUpdateIntervalId = null;
                    } else {
                        speechProgressUpdateIntervalId = null;
                    }
                }
            }, 50);
            
            // インターバルIDを保存
            if (type === 'translation') {
                translationProgressUpdateIntervalId = intervalId;
            } else {
                speechProgressUpdateIntervalId = intervalId;
            }
        }



        function shouldClearText() {
            // Check if each process is enabled and if it's complete
            var recogComplete = isSpeechRecognitionComplete;
            var trans1Complete = arg_trans != null ? isTextTranslation1Complete : true;
            var trans2Complete = arg_trans2 != null ? isTextTranslation2Complete : true;
            var trans3Complete = arg_trans3 != null ? isTextTranslation3Complete : true;

            return recogComplete && trans1Complete && trans2Complete && trans3Complete;
        }


        stop_recog = function() {
            console.log("stop by short pause!");
            recognition.stop();
            // ショートポーズで停止した場合はタイマー開始しない（onspeechend/onsoundendで開始済み）
        };

        ///////////////////////////////////////////////////////////
        // 各種イベントへの対応 --------------------------------- 
        // 音声・認識 開始
        recognition.onstart = () => {
            console.log("onstart cnt:" + String(my_count));
            // 音声認識開始時はタイマーリセットしない（実際の音声検出時にリセット）
        }
        recognition.onaudiostart = () => {
            console.log("onaudiostart cnt:" + String(my_count));
        }
        recognition.onsoundstart = () => {
            console.log("🔊 onsoundstart cnt:" + String(my_count));
            // 音声検出開始時に音声タイマーリセット
            resetSpeechTimer();
        }
        recognition.onspeechstart = () => {
            console.log("🗣️ onspeechstart cnt:" + String(my_count));
            // 発話開始時に音声タイマーリセット
            resetSpeechTimer();
        }
        
        // 音声・認識 終了
        recognition.onspeechend = () => {
            console.log("🔇 onspeechend cnt:" + String(my_count));
            // 発話終了時はタイマー開始しない（最終結果取得時に開始）
        }
        recognition.onsoundend = () => {
            console.log("🔕 onsoundend cnt:" + String(my_count));
            // 音声検出終了時はタイマー開始しない（最終結果取得時に開始）
        }
        recognition.onaudioend = () => {
            console.log("onaudioend cnt:" + String(my_count));
        }
        recognition.onend = () => {
            console.log("onend cnt:" + String(my_count));
            
            // 音声認識終了時はタイマー開始しない（onspeechend/onsoundendで既に開始済み）
            
            // フラグをリセット
            isSpeechRecognitionComplete = false;
            isTextTranslation1Complete = false;
            isTextTranslation2Complete = false;
            isTextTranslation3Complete = false;
            
            // 再起動
            setTimeout(() => {
                if (recognition) {
                    recognition.start();
                    my_count = count;
                    count = count + 1;
                }
            }, 100);
        }

        // エラー等
        recognition.onerror = (event) => {
            console.log("onerror cnt:" + String(my_count) + " error:" + event.error);
            
            // エラーの種類によって処理を分ける
            if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                console.log('マイクのアクセス許可が必要です');
                return; // 再起動しない
            }
            // その他のエラーは再起動
            setTimeout(() => {
                if (recognition) recognition.start();
            }, 1000);
        }
        recognition.onnomatch = () => {
            console.log("onnomatch cnt:" + String(my_count));
            // nomatchの場合は停止せず継続
        }


        // 言語設定 ----------------------------
        if (arg_recog != null) {
            recognition.lang = arg_recog;
            trans_sourcelang = recognition.lang;
            console.log('音声認識言語設定完了:', recognition.lang, 'trans_sourcelang:', trans_sourcelang);
        }
        if (arg_trans != null) {
            trans_destlang = arg_trans;
        }
        if (arg_trans2 != null) {
            trans2_destlang = arg_trans2;
        }
        if (arg_trans3 != null) {
            trans3_destlang = arg_trans3;
        }

        // 認識結果が返ってきたとき ------------------
        recognition.onresult = function(event) {
            var results = event.results;
            
            // 最新の結果を構築（確定結果 + 途中結果）
            var finalText = '';
            var interimText = '';
            var latestConfidence = 0;
            
            for (var i = 0; i < results.length; i++) {
                var transcript = results[i][0].transcript;
                var confidence = results[i][0].confidence || 0;
                
                if (results[i].isFinal) {
                    finalText += transcript;
                    if (confidence > 0) {
                        latestConfidence = confidence;
                    }
                } else {
                    interimText += transcript;
                }
            }
            
            // フィルタリングを適用
            var filteredFinalText = applyContentFilter(finalText);
            var filteredInterimText = applyContentFilter(interimText);
            
            // 表示用テキストを構築（フィルタリング済み確定部分 + フィルタリング済み途中部分）
            var displayText = filteredFinalText + filteredInterimText;
            var recog_text = displayText;  // 後続処理との互換性のため


                // 最新の結果に最終結果が含まれているかチェック
                var hasNewFinal = false;
                for (var j = event.resultIndex; j < results.length; j++) {
                    if (results[j].isFinal) {
                        hasNewFinal = true;
                        break;
                    }
                }
                
                // #################################################################
                // 認識最終結果が来たら ###############################################
                if (hasNewFinal)
                {
                    // 最終結果取得時に音声認識タイマー開始（発話終了とみなす）
                    console.log('🎤⚙️ 最終結果取得 - 音声認識タイマー開始 (テキスト:"' + finalText + '")');
                    
                    // 最終結果が空でない場合のみタイマー開始
                    if (finalText && finalText.trim() !== '') {
                        startSpeechDeleteTimer();
                    } else {
                        console.log('⚠️ 最終結果が空のためタイマー開始をスキップ');
                    }
                    // 認識結果を表示する（フィルタリング済み） ---------------------
                    var displayTextWithConfidence = filteredFinalText;
                    if (arg_showConfidence === 'true' && latestConfidence > 0) {
                        displayTextWithConfidence += ` (信頼度: ${Math.round(latestConfidence * 100)}%)`;
                    }
                    document.getElementById('speech_text-imb').innerHTML = displayTextWithConfidence;
                    document.getElementById('speech_text-bg').innerHTML = displayTextWithConfidence;
                    document.getElementById('speech_text-fg').innerHTML = displayTextWithConfidence;
                    isSpeechRecognitionComplete = true; // フラグを更新
                    
                    // 翻訳処理用に最終確定テキストのみを使用（フィルタリング済み）
                    recog_text = filteredFinalText;
                    lastFinalText = filteredFinalText;  // 表示用はフィルタリング済み


                    // 棒読みちゃんにコメントを送信する（フィルタリング済み）
                    if(bouyomi == "true") {
                        let bouyomiChanClient = new BouyomiChanClient();
                        bouyomiChanClient.talk(recog_text);
                    }

                    if(gasKeys.length > 0){
                        
                        // 翻訳開始ステータス
                        var activeTranslations = [];
                        if(arg_trans != null) activeTranslations.push('1');
                        if(arg_trans2 != null) activeTranslations.push('2');
                        if(arg_trans3 != null) activeTranslations.push('3');
                        if(activeTranslations.length > 0) {
                            updateTranslationStatus('翻訳中(' + activeTranslations.join(',') + ')', '#0066cc');
                        }

                        // 翻訳1言語目
                        if(arg_trans != null){
                            const processedText = applyCustomDictionary(recog_text);
                            let retry1 = 0;
                            const sendTranslation1 = function(){
                                query = TRANS_URL + '?text=' + encodeURIComponent(processedText) + '&source=' + trans_sourcelang + '&target=' + trans_destlang;
                                request = new XMLHttpRequest();
                                request.onreadystatechange = function(){
                                    if (request.readyState === 4 && request.status === 200){
                                        var responseText1 = request.responseText;
                                        try {
                                            var jsonResponse = JSON.parse(responseText1);
                                            if (jsonResponse.translatedText) {
                                                responseText1 = jsonResponse.translatedText;
                                                var translatedCount = jsonResponse.translatedCount;
                                                document.getElementById('translationCount').innerHTML = translatedCount;
                                                tokenUsage[currentGasKeyIndex] = translatedCount;
                                                if (translatedCount >= TOKEN_THRESHOLD) rotateGasKey();
                                                console.log('translatedCount(1):'+translatedCount);
                                            }
                                        } catch (e) {}

                                        document.getElementById('speech_text-imb').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-bg').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-fg').innerHTML = lastFinalText;
                                        var filteredResponseText1 = applyTranslationFilter(responseText1, 1);
                                        document.getElementById('trans_text-imb').innerHTML =  filteredResponseText1;
                                        document.getElementById('trans_text-bg').innerHTML =  filteredResponseText1;
                                        document.getElementById('trans_text-fg').innerHTML =  filteredResponseText1;
                                        isTextTranslation1Complete = true;
                                        startTranslationDeleteTimer();
                                        var completedTranslations = 0;
                                        var totalTranslations = 0;
                                        if(arg_trans != null) { totalTranslations++; if(isTextTranslation1Complete) completedTranslations++; }
                                        if(arg_trans2 != null) { totalTranslations++; if(isTextTranslation2Complete) completedTranslations++; }
                                        if(arg_trans3 != null) { totalTranslations++; if(isTextTranslation3Complete) completedTranslations++; }
                                        if(completedTranslations === totalTranslations) {
                                            updateTranslationStatus('翻訳完了', '#00aa00');
                                        }
                                    } else if (request.readyState === 4) {
                                        if ((request.status === 429 || request.status === 403 || request.status === 0) && retry1 < gasKeys.length - 1) {
                                            rotateGasKey();
                                            retry1++;
                                            sendTranslation1();
                                            return;
                                        } else {
                                            if (request.status === 429) {
                                                updateTranslationStatus('API上限エラー', '#cc0000');
                                            } else if (request.status === 403) {
                                                updateTranslationStatus('API認証エラー', '#cc0000');
                                            } else if (request.status === 0) {
                                                updateTranslationStatus('通信エラー', '#cc0000');
                                            } else {
                                                updateTranslationStatus('翻訳エラー(HTTP:' + request.status + ')', '#cc0000');
                                            }
                                        }
                                    }
                                };
                                request.open('GET', query, true);
                                request.send(null);
                            };
                            sendTranslation1();
                        }

                        // 翻訳2言語目
                        if(arg_trans2 != null){
                            const processedText2 = applyCustomDictionary(recog_text);
                            let retry2 = 0;
                            const sendTranslation2 = function(){
                                query2 = TRANS_URL + '?text=' + encodeURIComponent(processedText2) + '&source=' + trans_sourcelang + '&target=' + trans2_destlang;
                                request2 = new XMLHttpRequest();
                                request2.onreadystatechange = function(){
                                    if (request2.readyState === 4 && request2.status === 200){
                                        var responseText2 = request2.responseText;
                                        try {
                                            var jsonResponse = JSON.parse(responseText2);
                                            if (jsonResponse.translatedText) {
                                                responseText2 = jsonResponse.translatedText;
                                                var translatedCount2 = jsonResponse.translatedCount;
                                                document.getElementById('translationCount').innerHTML = translatedCount2;
                                                tokenUsage[currentGasKeyIndex] = translatedCount2;
                                                if (translatedCount2 >= TOKEN_THRESHOLD) rotateGasKey();
                                                console.log('translatedCount(2):'+translatedCount2);
                                            }
                                        } catch (e) {}

                                        document.getElementById('speech_text-imb').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-bg').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-fg').innerHTML = lastFinalText;
                                        var filteredResponseText2 = applyTranslationFilter(responseText2, 2);
                                        document.getElementById('trans_text2-imb').innerHTML = filteredResponseText2;
                                        document.getElementById('trans_text2-bg').innerHTML = filteredResponseText2;
                                        document.getElementById('trans_text2-fg').innerHTML = filteredResponseText2;
                                        isTextTranslation2Complete = true;
                                        startTranslationDeleteTimer();
                                        var completedTranslations = 0;
                                        var totalTranslations = 0;
                                        if(arg_trans != null) { totalTranslations++; if(isTextTranslation1Complete) completedTranslations++; }
                                        if(arg_trans2 != null) { totalTranslations++; if(isTextTranslation2Complete) completedTranslations++; }
                                        if(arg_trans3 != null) { totalTranslations++; if(isTextTranslation3Complete) completedTranslations++; }
                                        if(completedTranslations === totalTranslations) {
                                            updateTranslationStatus('翻訳完了', '#00aa00');
                                        }
                                    } else if (request2.readyState === 4) {
                                        if ((request2.status === 429 || request2.status === 403 || request2.status === 0) && retry2 < gasKeys.length - 1) {
                                            rotateGasKey();
                                            retry2++;
                                            sendTranslation2();
                                            return;
                                        } else {
                                            if (request2.status === 429) {
                                                updateTranslationStatus('API上限エラー', '#cc0000');
                                            } else if (request2.status === 403) {
                                                updateTranslationStatus('API認証エラー', '#cc0000');
                                            } else if (request2.status === 0) {
                                                updateTranslationStatus('通信エラー', '#cc0000');
                                            } else {
                                                updateTranslationStatus('翻訳エラー(HTTP:' + request2.status + ')', '#cc0000');
                                            }
                                        }
                                    }
                                };
                                request2.open('GET', query2, true);
                                request2.send(null);
                            };
                            sendTranslation2();
                        }

                        // 翻訳2言語目
                        if(arg_trans3 != null){
                            const processedText3 = applyCustomDictionary(recog_text);
                            let retry3 = 0;
                            const sendTranslation3 = function(){
                                query3 = TRANS_URL + '?text=' + encodeURIComponent(processedText3) + '&source=' + trans_sourcelang + '&target=' + trans3_destlang;
                                request3 = new XMLHttpRequest();
                                request3.onreadystatechange = function(){
                                    if (request3.readyState === 4 && request3.status === 200){
                                        var responseText3 = request3.responseText;
                                        try {
                                            var jsonResponse = JSON.parse(responseText3);
                                            if (jsonResponse.translatedText) {
                                                responseText3 = jsonResponse.translatedText;
                                                var translatedCount3 = jsonResponse.translatedCount;
                                                document.getElementById('translationCount').innerHTML = translatedCount3;
                                                tokenUsage[currentGasKeyIndex] = translatedCount3;
                                                if (translatedCount3 >= TOKEN_THRESHOLD) rotateGasKey();
                                                console.log('translatedCount(3):'+translatedCount3);
                                            }
                                        } catch (e) {}

                                        document.getElementById('speech_text-imb').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-bg').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-fg').innerHTML = lastFinalText;
                                        var filteredResponseText3 = applyTranslationFilter(responseText3, 3);
                                        document.getElementById('trans_text3-imb').innerHTML = filteredResponseText3;
                                        document.getElementById('trans_text3-bg').innerHTML = filteredResponseText3;
                                        document.getElementById('trans_text3-fg').innerHTML = filteredResponseText3;
                                        isTextTranslation3Complete = true;
                                        startTranslationDeleteTimer();
                                        var completedTranslations = 0;
                                        var totalTranslations = 0;
                                        if(arg_trans != null) { totalTranslations++; if(isTextTranslation1Complete) completedTranslations++; }
                                        if(arg_trans2 != null) { totalTranslations++; if(isTextTranslation2Complete) completedTranslations++; }
                                        if(arg_trans3 != null) { totalTranslations++; if(isTextTranslation3Complete) completedTranslations++; }
                                        if(completedTranslations === totalTranslations) {
                                            updateTranslationStatus('翻訳完了', '#00aa00');
                                        }
                                    } else if (request3.readyState === 4) {
                                        if ((request3.status === 429 || request3.status === 403 || request3.status === 0) && retry3 < gasKeys.length - 1) {
                                            rotateGasKey();
                                            retry3++;
                                            sendTranslation3();
                                            return;
                                        } else {
                                            if (request3.status === 429) {
                                                updateTranslationStatus('API上限エラー', '#cc0000');
                                            } else if (request3.status === 403) {
                                                updateTranslationStatus('API認証エラー', '#cc0000');
                                            } else if (request3.status === 0) {
                                                updateTranslationStatus('通信エラー', '#cc0000');
                                            } else {
                                                updateTranslationStatus('翻訳エラー(HTTP:' + request3.status + ')', '#cc0000');
                                            }
                                        }
                                    }
                                };
                                request3.open('GET', query3, true);
                                request3.send(null);
                            };
                            sendTranslation3();
                        }

                    } else {
                        document.getElementById('speech_text-imb').innerHTML = filteredFinalText;
                        document.getElementById('speech_text-bg').innerHTML = filteredFinalText;
                        document.getElementById('speech_text-fg').innerHTML = filteredFinalText;
                        // API KEYがない場合のステータス
                        updateTranslationStatus('API KEYなし', '#999');
                    }

                }
                // #################################################################
                // 認識途中結果が来たら ###############################################
                else
                {
                    // 途中結果取得時に音声認識タイマーリセット（音声入力中のため）
                    console.log('🔄 途中結果取得 - タイマーリセット (テキスト:"' + displayText + '")');
                    resetSpeechTimer();
                    // 「ショートポースが来たら，音声認識を強制的に止める」のタイムアウト処理を削除する -------
                    if(short_pause != null && short_pause !== '') {
                        clearTimeout(id_stop_recog);
                        // ショートポーズストップ用タイムアウトを設定
                        id_stop_recog = setTimeout(stop_recog, parseInt(short_pause));
                        console.log('ショートポーズタイマー設定:', short_pause + 'ms');
                    }

                    // 途中結果の表示（フィルタリング済み確定部分 + フィルタリング済み途中部分を明確に区別）
                    if(displayText !== ""){
                        var displayHtml = '';
                        if (filteredFinalText !== '') {
                            displayHtml += filteredFinalText;
                        }
                        if (filteredInterimText !== '') {
                            displayHtml += ' << ' + filteredInterimText + ' >>';
                        }
                        
                        document.getElementById('speech_text-imb').innerHTML = displayHtml;
                        document.getElementById('speech_text-bg').innerHTML = displayHtml;
                        document.getElementById('speech_text-fg').innerHTML = displayHtml;
                    }
                }
            // 単一ループに統合
        }

        // 音声デバイス初期化後に音声認識を開始
        initializeAudioDevice().then(() => {
            recognition.start();
            console.log("recog start: cnt:" + String(my_count));
            // 初期ステータス設定
            if (gasKeys.length > 0) {
                updateTranslationStatus('待機中', '#666');
            } else {
                updateTranslationStatus('API KEYなし', '#999');
            }
        }).catch(() => {
            // エラーが発生してもデフォルトデバイスで開始
            recognition.start();
            console.log("recog start (default device): cnt:" + String(my_count));
            // 初期ステータス設定
            if (gasKeys.length > 0) {
                updateTranslationStatus('待機中', '#666');
            } else {
                updateTranslationStatus('API KEYなし', '#999');
            }
        });

    </script> 
</head>
 





<body>
    <div class="big" id="result_text">
        <table id="text_table" class="btm_table" style="overflow:hidden;">
            <tr><td id="tbl_td" align="center" valign='bottom'>
                <div id="speech_text">
                    <div class="stroke-single-bg" id="speech_text-bg"></div> 
                    <div class="stroke-single-fg" id="speech_text-fg"></div>
                    <div class="stroke-single-imb" id="speech_text-imb"></div> 
                </div>

                <div id="trans_text">
                    <div class="stroke-single-bg" id="trans_text-bg"></div>  
                    <div class="stroke-single-fg" id="trans_text-fg"></div>  
                    <div class="stroke-single-imb" id="trans_text-imb"></div>  
                </div>

                <div id="trans_text2">
                    <div class="stroke-single-bg" id="trans_text2-bg"></div>  
                    <div class="stroke-single-fg" id="trans_text2-fg"></div>  
                    <div class="stroke-single-imb" id="trans_text2-imb"></div>  
                </div>

                <div id="trans_text3">
                    <div class="stroke-single-bg" id="trans_text3-bg"></div>  
                    <div class="stroke-single-fg" id="trans_text3-fg"></div>  
                    <div class="stroke-single-imb" id="trans_text3-imb"></div>  
                </div>
            </td></tr>
        </table>
    </div>

    <!-- 翻訳回数管理 -->
    <div id="translationCount" style="display: none;"></div>

</body>









<!-- ############## 末尾のjavascript ############## -->
<script type="text/javascript">

// バージョン情報の表示 ---------------------------------
const SoftwareTitle = "音声認識字幕ちゃん";
const SoftwareVersion = "2025.6.9 10:18";
const SoftwareDeveloper = "[開発者：さぁたん ＆ さよなりω/(大学教員)西村良太]"

// Web Speech API使用時のデバイス制限について
console.log('音声認識: Web Speech APIは既定の音声デバイスのみ使用');
console.log('デバイスを変更する場合は、ブラウザまたはOSの設定で既定デバイスを変更してください。');

const speech_text_first = "[" + SoftwareTitle + " (Ver:" + SoftwareVersion + ")" + "]";
document.getElementById('speech_text-bg').innerHTML = speech_text_first;
document.getElementById('speech_text-fg').innerHTML = speech_text_first;
document.getElementById('speech_text-imb').innerHTML = speech_text_first;

const trans1_text_first = SoftwareDeveloper;
document.getElementById('trans_text-bg').innerHTML = trans1_text_first
document.getElementById('trans_text-fg').innerHTML = trans1_text_first
document.getElementById('trans_text-imb').innerHTML = trans1_text_first

const trans2_text_first = "[ここに結果表示（翻訳２）]";
document.getElementById('trans_text2-bg').innerHTML = trans2_text_first;
document.getElementById('trans_text2-fg').innerHTML = trans2_text_first;
document.getElementById('trans_text2-imb').innerHTML = trans2_text_first;

const trans3_text_first = "[ここに結果表示（翻訳３）]";
document.getElementById('trans_text3-bg').innerHTML = trans3_text_first;
document.getElementById('trans_text3-fg').innerHTML = trans3_text_first;
document.getElementById('trans_text3-imb').innerHTML = trans3_text_first;


// 対象言語を利用しない場合，初期表示文の削除 /////
if (getParam('trans') == null) {
    document.getElementById('trans_text-bg').innerHTML = '';
    document.getElementById('trans_text-fg').innerHTML = '';
    document.getElementById('trans_text-imb').innerHTML = '';
}
if (getParam('trans2') == null) {
    document.getElementById('trans_text2-bg').innerHTML = '';
    document.getElementById('trans_text2-fg').innerHTML = '';
    document.getElementById('trans_text2-imb').innerHTML = '';
}
if (getParam('trans3') == null) {
    document.getElementById('trans_text3-bg').innerHTML = '';
    document.getElementById('trans_text3-fg').innerHTML = '';
    document.getElementById('trans_text3-imb').innerHTML = '';
}

// 表示スタイル変更 ---------------------------------
if (getParam('bgcolor') != null){
    document.bgColor = getParam('bgcolor');
}

if (getParam('v_align') == "top"){
    document.getElementById("text_table").style.bottom = -1;
} else if(getParam('v_align') == "bottom"){
    document.getElementById("text_table").style.bottom = 0;
}

if (getParam('textAlign') != null){
    document.getElementById("text_table").style.textAlign = getParam('textAlign');
    document.getElementById("tbl_td").style.textAlign = getParam('textAlign');
    if(getParam('textAlign') == "right"){
        document.getElementById("text_table").style.direction = "rtl";
        document.getElementById("tbl_td").style.direction = "rtl";
        document.body.style.direction = "rtl";
    }
}

if (getParam('whiteSpace') != null){
    document.getElementById("text_table").style.whiteSpace = getParam('whiteSpace');
}

// 高さ合わせ用フォント（色を背景色と同じにする） ############################################
// 音声認識テキスト -------
if (getParam('bgcolor') != null){
    document.getElementById("speech_text-imb").style.webkitTextStrokeColor = getParam('bgcolor');
    document.getElementById("speech_text-imb").style.color = getParam('bgcolor');
}
if (getParam('st_width1') != null){
    document.getElementById("speech_text-imb").style.webkitTextStrokeWidth = getParam('st_width1') + 'pt';
}

// 翻訳結果テキスト -------
if (getParam('bgcolor') != null){
    document.getElementById("trans_text-imb").style.webkitTextStrokeColor = getParam('bgcolor');
    document.getElementById("trans_text-imb").style.color = getParam('bgcolor');
}
if (getParam('st_width2') != null){
    document.getElementById("trans_text-imb").style.webkitTextStrokeWidth = getParam('st_width2') + 'pt';
}

// 翻訳結果テキスト（第2言語） -------
if (getParam('bgcolor') != null){
    document.getElementById("trans_text2-imb").style.webkitTextStrokeColor = getParam('bgcolor');
    document.getElementById("trans_text2-imb").style.color = getParam('bgcolor');
}
if (getParam('st_width3') != null){
    document.getElementById("trans_text2-imb").style.webkitTextStrokeWidth = getParam('st_width3') + 'pt';
}

// 翻訳結果テキスト（第3言語） -------
if (getParam('bgcolor') != null){
    document.getElementById("trans_text3-imb").style.webkitTextStrokeColor = getParam('bgcolor');
    document.getElementById("trans_text3-imb").style.color = getParam('bgcolor');
}
if (getParam('st_width4') != null){
    document.getElementById("trans_text3-imb").style.webkitTextStrokeWidth = getParam('st_width4') + 'pt';
}



// 表示設定 ############################################
// 全体共通 ----------------

// 音声認識結果 ----------------
if (getParam('speech_text_font') != null){
    document.getElementById("speech_text").style.fontFamily = "'" + getParam('speech_text_font') + "'";
}

if (getParam('size1') != null){
    document.getElementById("speech_text").style.fontSize = getParam('size1') + 'pt';
}

if (getParam('weight1') != null){
    document.getElementById("speech_text").style.fontWeight = getParam('weight1');
}

if (getParam('color1') != null){
    document.getElementById("speech_text-fg").style.color = getParam('color1');
}

if (getParam('st_color1') != null){
    document.getElementById("speech_text-bg").style.webkitTextStrokeColor = getParam('st_color1');
}

if (getParam('st_width1') != null){
    document.getElementById("speech_text-bg").style.webkitTextStrokeWidth = getParam('st_width1') + 'pt';
}

// 翻訳結果テキスト ----------------
if (getParam('trans_text_font') != null){
    document.getElementById("trans_text").style.fontFamily = "'" + getParam('trans_text_font') + "'";
}

if (getParam('size2') != null){
    document.getElementById("trans_text").style.fontSize = getParam('size2') + 'pt';
}

if (getParam('weight2') != null){
    document.getElementById("trans_text").style.fontWeight = getParam('weight2');
}

if (getParam('color2') != null){
    document.getElementById("trans_text-fg").style.color = getParam('color2');
}

if (getParam('st_color2') != null){
    document.getElementById("trans_text-bg").style.webkitTextStrokeColor = getParam('st_color2');
}

if (getParam('st_width2') != null){
    document.getElementById("trans_text-bg").style.webkitTextStrokeWidth = getParam('st_width2') + 'pt';
}

// 翻訳結果テキスト（第2言語） -----------
if (getParam('trans_text2_font') != null){
    document.getElementById("trans_text2").style.fontFamily = "'" + getParam('trans_text2_font') + "'";
}


if (getParam('size3') != null){
    document.getElementById("trans_text2").style.fontSize = getParam('size3') + 'pt';
}

if (getParam('weight3') != null){
    document.getElementById("trans_text2").style.fontWeight = getParam('weight3');
}

if (getParam('color3') != null){
    document.getElementById("trans_text2-fg").style.color = getParam('color3');
}

if (getParam('st_color3') != null){
    document.getElementById("trans_text2-bg").style.webkitTextStrokeColor = getParam('st_color3');
}

if (getParam('st_width3') != null){
    document.getElementById("trans_text2-bg").style.webkitTextStrokeWidth = getParam('st_width3') + 'pt';
}

// 翻訳結果テキスト（第2言語） -----------
if (getParam('trans_text3_font') != null){
    document.getElementById("trans_text3").style.fontFamily = "'" + getParam('trans_text3_font') + "'";
}


if (getParam('size4') != null){
    document.getElementById("trans_text3").style.fontSize = getParam('size4') + 'pt';
}

if (getParam('weight4') != null){
    document.getElementById("trans_text3").style.fontWeight = getParam('weight4');
}

if (getParam('color4') != null){
    document.getElementById("trans_text3-fg").style.color = getParam('color4');
}

if (getParam('st_color4') != null){
    document.getElementById("trans_text3-bg").style.webkitTextStrokeColor = getParam('st_color4');
}

if (getParam('st_width4') != null){
    document.getElementById("trans_text3-bg").style.webkitTextStrokeWidth = getParam('st_width4') + 'pt';
}

</script>




</html>